name: Publish Dev API to Scalar

on:
  repository_dispatch:
    types: [trigger-dev]

jobs:
  publish-to-scalar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - run: sudo apt-get update -y && sudo apt-get install -y jq curl

      - name: Discover CloudFront Distribution ID (by alias)
        run: |
          ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Aliases.Items, 'docs-api-dev.diversifi.ai')].Id | [0]" \
            --output text)
          echo "CLOUDFRONT_DISTRIBUTION_ID=$ID" >> $GITHUB_ENV

      - name: Publish and Upload
        env:
          SCALAR_TOKEN: ${{ secrets.SCALAR_TOKEN }}
          S3_BUCKET: docs-api-dev-diversifi-ai
        run: bash scripts/publish-scalar-dev.sh
